<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Untracked Files</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      background: #f5f3f0;
      color: #1a1a1a;
      font-family: 'Inter', sans-serif;
      height: 100%;
      overflow: hidden;
    }

    #title {
      width: 100%;
      font-size: 32px;
      font-weight: 600;
      line-height: 1.1;
      text-transform: uppercase;
      letter-spacing: -0.02em;
      padding-bottom: 12px;
    }

    .sm { font-size: 11px; color: #999; }

    #filters {
      position: fixed;
      top: 16px; left: 32px;
      z-index: 20;
      display: flex;
      gap: 16px;
      align-items: center;
    }

    #filters label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    #filters input[type="range"] {
      width: 50px;
      accent-color: #1a1a1a;
    }

    #player-area {
      position: fixed;
      top: 44px; bottom: 40px; left: 0; right: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-arrow {
      width: 100px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 48px;
      font-weight: 600;
      color: #ccc;
      transition: color 0.15s;
      user-select: none;
      flex-shrink: 0;
    }

    .nav-arrow:hover { color: #666; }
    .nav-arrow:active { color: #1a1a1a; }

    #video-wrap {
      flex: 1;
      max-width: 780px;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #video-frame {
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      overflow: hidden;
      position: relative;
    }

    #video-frame iframe {
      width: 100%;
      height: calc(100% + 100px);
      margin-top: -50px;
      border: none;
    }

    /* --- Custom controls --- */
    #controls {
      width: 100%;
      padding: 8px 0 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #btn-play {
      width: 20px;
      height: 20px;
      cursor: pointer;
      color: #999;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: color 0.15s;
    }
    #btn-play:hover { color: #1a1a1a; }

    #seekbar-wrap {
      flex: 1;
      height: 20px;
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    #seekbar {
      width: 100%;
      height: 3px;
      background: #ddd;
      border-radius: 2px;
      position: relative;
    }

    #seekbar-fill {
      height: 100%;
      background: #999;
      border-radius: 2px;
      width: 0%;
      transition: width 0.2s linear;
    }

    #seekbar-wrap:hover #seekbar { height: 5px; }
    #seekbar-wrap:hover #seekbar-fill { background: #1a1a1a; }

    #time {
      font-size: 10px;
      color: #bbb;
      min-width: 70px;
      text-align: right;
      flex-shrink: 0;
    }

    #vol-wrap {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    #btn-mute {
      cursor: pointer;
      font-size: 12px;
      color: #bbb;
      transition: color 0.15s;
    }
    #btn-mute:hover { color: #1a1a1a; }

    #vol-bar {
      width: 50px;
      height: 3px;
      background: #ddd;
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }

    #vol-fill {
      height: 100%;
      background: #999;
      border-radius: 2px;
      width: 80%;
    }

    #vol-wrap:hover #vol-fill { background: #1a1a1a; }

    /* --- Info --- */
    #info {
      width: 100%;
      padding: 6px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    #btn-fav {
      font-size: 16px;
      cursor: pointer;
      color: #ccc;
      transition: color 0.15s;
    }
    #btn-fav:hover { color: #999; }
    #btn-fav.active { color: #c44; }

    #rating { display: flex; gap: 1px; }
    .star {
      font-size: 13px;
      cursor: pointer;
      color: #ddd;
      transition: color 0.15s;
    }
    .star.filled { color: #1a1a1a; }
    .star:hover { color: #888; }

    #bottom {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      padding: 10px 32px;
      display: flex;
      justify-content: space-between;
    }

    #loading {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f3f0;
      z-index: 100;
    }
    #loading.hidden { display: none; }
  </style>
</head>
<body>

<div id="loading" class="sm">Loading...</div>

<div id="filters" class="sm">
  <label><input type="checkbox" id="f-cam" checked> camera names</label>
  <label><input type="checkbox" id="f-ext" checked> file ext</label>
  <label>words <span id="f-words-val">4</span> <input type="range" id="f-words" min="1" max="10" value="4"></label>
  <label>views <span id="f-views-val">2k</span> <input type="range" id="f-views" min="0" max="2000" value="2000" step="100"></label>
  <span id="filter-count"></span>
</div>

<div id="player-area">
  <div class="nav-arrow" onclick="prev()">&#8592;</div>
  <div id="video-wrap">
    <h1 id="title">Untracked Files</h1>
    <div id="video-frame"><div id="yt-player"></div></div>
    <div id="controls">
      <div id="btn-play" onclick="togglePlay()">&#9654;</div>
      <div id="seekbar-wrap" onclick="seek(event)">
        <div id="seekbar"><div id="seekbar-fill"></div></div>
      </div>
      <div id="time" class="sm">0:00 / 0:00</div>
      <div id="vol-wrap">
        <div id="btn-mute" onclick="toggleMute()">&#9834;</div>
        <div id="vol-bar" onclick="setVol(event)"><div id="vol-fill"></div></div>
      </div>
    </div>
    <div id="info">
      <span class="sm"><span id="vid-title" style="color:#1a1a1a;font-weight:600"></span> <span id="vid-meta"></span></span>
      <span style="display:flex;align-items:center;gap:10px">
        <span id="rating"></span>
        <span id="btn-fav" onclick="toggleFavorite()">&#9829;</span>
      </span>
    </div>
  </div>
  <div class="nav-arrow" onclick="next()">&#8594;</div>
</div>

<div id="bottom" class="sm">
  <span id="counter"></span>
  <span>&#8592;/&#8594; navigate &middot; 1-5 rate &middot; F fav &middot; 0 reject &middot; space pause</span>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
  const CAM_RE = /^(MVI|DSC[N]?|IMG|MOV|VID|SAM|SDV|P10|DSCF|M2U|MAH|C00|video)[_ ]?\d/i;
  const EXT_RE = /\.(mov|avi|mpg|mpeg|wmv|3gp|mp4|mts|vob|flv)$/i;

  let rawVideos = [], allVideos = [], queue = [], history = [];
  let current = null, seenIds = new Set(), viewCount = 0;
  let player = null, ytReady = false, userHasInteracted = false;
  let progressInterval = null;

  window.onYouTubeIframeAPIReady = () => { ytReady = true; };

  function onFirstInteraction() {
    if (userHasInteracted) return;
    userHasInteracted = true;
    if (player && player.isMuted()) player.unMute();
    document.removeEventListener("click", onFirstInteraction);
    document.removeEventListener("keydown", onFirstInteraction);
  }
  document.addEventListener("click", onFirstInteraction);
  document.addEventListener("keydown", onFirstInteraction);

  function getStore() {
    try { return JSON.parse(localStorage.getItem("yt-feed-store") || "{}"); }
    catch { return {}; }
  }
  function saveStore(s) { localStorage.setItem("yt-feed-store", JSON.stringify(s)); }

  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function wordCount(t) { return t.trim().split(/[\s_\-\.]+/).filter(Boolean).length; }
  function fmtViews(n) { return n >= 1000 ? (n/1000).toFixed(n>=10000?0:1)+"k" : String(n); }

  function fmtTime(s) {
    if (!s || isNaN(s)) return "0:00";
    const m = Math.floor(s / 60);
    const sec = Math.floor(s % 60);
    return `${m}:${sec.toString().padStart(2, "0")}`;
  }

  // --- Progress bar update ---
  function startProgress() {
    if (progressInterval) clearInterval(progressInterval);
    progressInterval = setInterval(() => {
      if (!player || !player.getCurrentTime) return;
      const cur = player.getCurrentTime();
      const dur = player.getDuration();
      if (dur > 0) {
        document.getElementById("seekbar-fill").style.width = `${(cur / dur) * 100}%`;
        document.getElementById("time").textContent = `${fmtTime(cur)} / ${fmtTime(dur)}`;
      }
    }, 250);
  }

  // --- Custom controls ---
  function togglePlay() {
    if (!player) return;
    const state = player.getPlayerState();
    if (state === 1) {
      player.pauseVideo();
      document.getElementById("btn-play").innerHTML = "&#9654;";
    } else {
      player.playVideo();
      document.getElementById("btn-play").innerHTML = "&#9646;&#9646;";
    }
  }

  function seek(e) {
    if (!player || !player.getDuration) return;
    const bar = document.getElementById("seekbar-wrap");
    const rect = bar.getBoundingClientRect();
    const pct = (e.clientX - rect.left) / rect.width;
    player.seekTo(pct * player.getDuration(), true);
  }

  function toggleMute() {
    if (!player) return;
    if (player.isMuted()) {
      player.unMute();
      document.getElementById("btn-mute").innerHTML = "&#9834;";
    } else {
      player.mute();
      document.getElementById("btn-mute").innerHTML = "&#9835;";
    }
  }

  function setVol(e) {
    if (!player) return;
    const bar = document.getElementById("vol-bar");
    const rect = bar.getBoundingClientRect();
    const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    player.setVolume(Math.round(pct * 100));
    document.getElementById("vol-fill").style.width = `${pct * 100}%`;
    if (player.isMuted()) player.unMute();
  }

  // --- Filters ---
  function applyFilters() {
    const cam = document.getElementById("f-cam").checked;
    const ext = document.getElementById("f-ext").checked;
    const maxW = parseInt(document.getElementById("f-words").value);
    const maxV = parseInt(document.getElementById("f-views").value);
    const store = getStore();

    allVideos = rawVideos.filter(v => {
      if ((store[v.id]?.rating ?? -1) === 0) return false;
      if (cam && !CAM_RE.test(v.title)) return false;
      if (ext && !EXT_RE.test(v.title)) return false;
      if (wordCount(v.title) > maxW) return false;
      if (v.views > maxV) return false;
      return true;
    });

    seenIds.clear(); queue = shuffle(allVideos); history = [];
    document.getElementById("filter-count").textContent = `${allVideos.length} / ${rawVideos.length}`;
    if (allVideos.length > 0) showVideo(queue.shift());
    else {
      if (player) { player.destroy(); player = null; }
      document.getElementById("video-frame").innerHTML = '<div id="yt-player"></div>';
      document.getElementById("vid-title").textContent = "No results";
      document.getElementById("vid-meta").textContent = "";
    }
  }

  document.getElementById("f-cam").addEventListener("change", applyFilters);
  document.getElementById("f-ext").addEventListener("change", applyFilters);
  document.getElementById("f-words").addEventListener("input", e => {
    document.getElementById("f-words-val").textContent = e.target.value;
    applyFilters();
  });
  document.getElementById("f-views").addEventListener("input", e => {
    document.getElementById("f-views-val").textContent = fmtViews(parseInt(e.target.value));
    applyFilters();
  });

  async function loadData() { rawVideos = await (await fetch("data.json")).json(); }

  function fillQueue() {
    if (queue.length < 5) queue.push(...shuffle(allVideos.filter(v => !seenIds.has(v.id))));
  }

  function onPlayerStateChange(event) {
    if (event.data === 1) {
      // Playing
      document.getElementById("btn-play").innerHTML = "&#9646;&#9646;";
      startProgress();
    } else if (event.data === 2) {
      // Paused
      document.getElementById("btn-play").innerHTML = "&#9654;";
    } else if (event.data === 0) {
      // Ended
      next();
    }
  }

  function playVideo(videoId) {
    if (player) {
      player.loadVideoById(videoId);
    } else {
      player = new YT.Player('yt-player', {
        videoId: videoId,
        playerVars: {
          autoplay: 1,
          controls: 0,
          modestbranding: 1,
          rel: 0,
          playsinline: 1,
          iv_load_policy: 3,
          disablekb: 1,
          fs: 0,
          cc_load_policy: 0
        },
        events: {
          onStateChange: onPlayerStateChange,
          onError: () => {
            if (player && !player.isMuted()) { player.mute(); player.playVideo(); }
          },
          onReady: () => {
            setTimeout(() => {
              if (player.getPlayerState() !== 1) { player.mute(); player.playVideo(); }
            }, 1000);
            // Set initial volume display
            document.getElementById("vol-fill").style.width = `${player.getVolume()}%`;
          }
        }
      });
    }
  }

  function showVideo(video) {
    if (!video) return;
    current = video; seenIds.add(video.id); viewCount++;
    const store = getStore(), meta = store[video.id] || {};
    document.getElementById("vid-title").textContent = video.title;
    document.getElementById("vid-meta").textContent =
      `\u2014 ${video.channel || "?"} \u00b7 ${video.views?.toLocaleString()||"?"} views \u00b7 ${video.published||""}`;
    document.getElementById("counter").textContent = `${viewCount} viewed`;
    document.getElementById("seekbar-fill").style.width = "0%";
    document.getElementById("time").textContent = "0:00 / 0:00";
    renderRating(meta.rating || -1);
    document.getElementById("btn-fav").classList.toggle("active", !!meta.favorited);
    playVideo(video.id);
    fillQueue();
  }

  function next() { if(!queue.length) fillQueue(); if(!queue.length) return; if(current) history.push(current); showVideo(queue.shift()); }
  function prev() { if(!history.length) return; if(current) queue.unshift(current); showVideo(history.pop()); }

  function renderRating(r) {
    const c = document.getElementById("rating"); c.innerHTML = "";
    for (let i=1;i<=5;i++) { const s=document.createElement("span"); s.className=`star ${i<=r?"filled":""}`; s.textContent="\u2605"; s.onclick=()=>rateVideo(i); c.appendChild(s); }
  }
  function rateVideo(r) { if(!current) return; const s=getStore(); s[current.id]={...(s[current.id]||{}),rating:r}; saveStore(s); renderRating(r); if(r===0) next(); }
  function toggleFavorite() { if(!current) return; const s=getStore(),m=s[current.id]||{}; m.favorited=!m.favorited; s[current.id]=m; saveStore(s); document.getElementById("btn-fav").classList.toggle("active",m.favorited); }

  document.addEventListener("keydown", e => {
    if(e.key==="ArrowRight"||e.key==="j"){e.preventDefault();next();}
    else if(e.key==="ArrowLeft"||e.key==="k"){e.preventDefault();prev();}
    else if(e.key===" "){e.preventDefault();togglePlay();}
    else if(e.key==="m") toggleMute();
    else if(e.key==="f") toggleFavorite();
    else if(e.key>="1"&&e.key<="5") rateVideo(parseInt(e.key));
    else if(e.key==="0") rateVideo(0);
  });

  (async () => {
    await loadData();
    while (!ytReady) await new Promise(r => setTimeout(r, 50));
    document.getElementById("loading").classList.add("hidden");
    applyFilters();
  })();
</script>
</body>
</html>
