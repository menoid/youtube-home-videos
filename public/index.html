<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home Videos</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      background: #f5f3f0;
      color: #1a1a1a;
      font-family: 'Inter', sans-serif;
      height: 100%;
      overflow: hidden;
    }

    #top {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 20;
      padding: 24px 32px 0;
    }

    #top h1 {
      font-size: 32px;
      font-weight: 600;
      line-height: 1.1;
      text-transform: uppercase;
      letter-spacing: -0.02em;
    }

    .sm { font-size: 11px; color: #999; }

    #filters {
      position: fixed;
      top: 66px; left: 32px;
      z-index: 20;
      display: flex;
      gap: 16px;
      align-items: center;
    }

    #filters label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    #filters input[type="range"] {
      width: 50px;
      accent-color: #1a1a1a;
    }

    #player-area {
      position: fixed;
      top: 100px; bottom: 40px; left: 0; right: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-arrow {
      width: 100px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 48px;
      font-weight: 600;
      color: #ccc;
      transition: color 0.15s;
      user-select: none;
      flex-shrink: 0;
    }

    .nav-arrow:hover { color: #666; }
    .nav-arrow:active { color: #1a1a1a; }

    #video-wrap {
      flex: 1;
      max-width: 780px;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #video-frame {
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      overflow: hidden;
      position: relative;
    }

    #video-frame iframe {
      width: 100%;
      height: calc(100% + 100px);
      margin-top: -50px;
      border: none;
    }

    #info {
      width: 100%;
      padding: 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    #btn-fav {
      font-size: 16px;
      cursor: pointer;
      color: #ccc;
      transition: color 0.15s;
    }
    #btn-fav:hover { color: #999; }
    #btn-fav.active { color: #c44; }

    #rating { display: flex; gap: 1px; }
    .star {
      font-size: 13px;
      cursor: pointer;
      color: #ddd;
      transition: color 0.15s;
    }
    .star.filled { color: #1a1a1a; }
    .star:hover { color: #888; }

    #bottom {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      padding: 10px 32px;
      display: flex;
      justify-content: space-between;
    }

    #loading {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f3f0;
      z-index: 100;
    }
    #loading.hidden { display: none; }
  </style>
</head>
<body>

<div id="loading" class="sm">Loading...</div>

<div id="top">
  <h1>Home Videos</h1>
</div>

<div id="filters" class="sm">
  <label><input type="checkbox" id="f-cam" checked> camera names</label>
  <label><input type="checkbox" id="f-ext"> file ext</label>
  <label>words <span id="f-words-val">4</span> <input type="range" id="f-words" min="1" max="10" value="4"></label>
  <label>views <span id="f-views-val">2k</span> <input type="range" id="f-views" min="0" max="2000" value="2000" step="100"></label>
  <span id="filter-count"></span>
</div>

<div id="player-area">
  <div class="nav-arrow" onclick="prev()">&#8592;</div>
  <div id="video-wrap">
    <div id="video-frame"><div id="yt-player"></div></div>
    <div id="info">
      <span class="sm"><span id="vid-title" style="color:#1a1a1a;font-weight:600"></span> <span id="vid-meta"></span></span>
      <span style="display:flex;align-items:center;gap:10px">
        <span id="rating"></span>
        <span id="btn-fav" onclick="toggleFavorite()">&#9829;</span>
      </span>
    </div>
  </div>
  <div class="nav-arrow" onclick="next()">&#8594;</div>
</div>

<div id="bottom" class="sm">
  <span id="counter"></span>
  <span>&#8592;/&#8594; navigate &middot; 1-5 rate &middot; F fav &middot; 0 reject</span>
</div>

<!-- YouTube IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>

<script>
  const CAM_RE = /^(MVI|DSC[N]?|IMG|MOV|VID|SAM|SDV|P10|DSCF|M2U|MAH|C00|video)[_ ]?\d/i;
  const EXT_RE = /\.(mov|avi|mpg|mpeg|wmv|3gp|mp4|mts|vob|flv)$/i;

  let rawVideos = [], allVideos = [], queue = [], history = [];
  let current = null, seenIds = new Set(), viewCount = 0;
  let player = null;
  let ytReady = false;
  let userHasInteracted = false;

  // YouTube IFrame API callback
  window.onYouTubeIframeAPIReady = () => { ytReady = true; };

  // Unmute on first user interaction
  function onFirstInteraction() {
    if (userHasInteracted) return;
    userHasInteracted = true;
    if (player && player.isMuted()) player.unMute();
    document.removeEventListener("click", onFirstInteraction);
    document.removeEventListener("keydown", onFirstInteraction);
  }
  document.addEventListener("click", onFirstInteraction);
  document.addEventListener("keydown", onFirstInteraction);

  function getStore() {
    try { return JSON.parse(localStorage.getItem("yt-feed-store") || "{}"); }
    catch { return {}; }
  }
  function saveStore(s) { localStorage.setItem("yt-feed-store", JSON.stringify(s)); }

  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function wordCount(t) { return t.trim().split(/[\s_\-\.]+/).filter(Boolean).length; }
  function fmtViews(n) { return n >= 1000 ? (n/1000).toFixed(n>=10000?0:1)+"k" : String(n); }

  function applyFilters() {
    const cam = document.getElementById("f-cam").checked;
    const ext = document.getElementById("f-ext").checked;
    const maxW = parseInt(document.getElementById("f-words").value);
    const maxV = parseInt(document.getElementById("f-views").value);
    const store = getStore();

    allVideos = rawVideos.filter(v => {
      if ((store[v.id]?.rating ?? -1) === 0) return false;
      if (cam && !CAM_RE.test(v.title)) return false;
      if (ext && !EXT_RE.test(v.title)) return false;
      if (wordCount(v.title) > maxW) return false;
      if (v.views > maxV) return false;
      return true;
    });

    seenIds.clear(); queue = shuffle(allVideos); history = [];
    document.getElementById("filter-count").textContent = `${allVideos.length} / ${rawVideos.length}`;
    if (allVideos.length > 0) showVideo(queue.shift());
    else {
      if (player) { player.destroy(); player = null; }
      document.getElementById("video-frame").innerHTML = '<div id="yt-player"></div>';
      document.getElementById("vid-title").textContent = "No results";
      document.getElementById("vid-meta").textContent = "";
    }
  }

  document.getElementById("f-cam").addEventListener("change", applyFilters);
  document.getElementById("f-ext").addEventListener("change", applyFilters);
  document.getElementById("f-words").addEventListener("input", e => {
    document.getElementById("f-words-val").textContent = e.target.value;
    applyFilters();
  });
  document.getElementById("f-views").addEventListener("input", e => {
    document.getElementById("f-views-val").textContent = fmtViews(parseInt(e.target.value));
    applyFilters();
  });

  async function loadData() { rawVideos = await (await fetch("data.json")).json(); }

  function fillQueue() {
    if (queue.length < 5) queue.push(...shuffle(allVideos.filter(v => !seenIds.has(v.id))));
  }

  function onPlayerStateChange(event) {
    // PLAYING = 1: unmute if user has interacted
    if (event.data === 1 && userHasInteracted && player.isMuted()) {
      player.unMute();
    }
    // ENDED = 0: auto-next
    if (event.data === 0) {
      next();
    }
  }

  function playVideo(videoId) {
    if (player) {
      player.loadVideoById(videoId);
    } else {
      // Create player for first time
      player = new YT.Player('yt-player', {
        videoId: videoId,
        playerVars: {
          autoplay: 1,
          mute: 1,
          controls: 0,
          modestbranding: 1,
          rel: 0,
          playsinline: 1,
          iv_load_policy: 3,
          disablekb: 1,
          fs: 0,
          cc_load_policy: 0
        },
        events: {
          onStateChange: onPlayerStateChange
        }
      });
    }
  }

  function showVideo(video) {
    if (!video) return;
    current = video; seenIds.add(video.id); viewCount++;
    const store = getStore(), meta = store[video.id] || {};
    document.getElementById("vid-title").textContent = video.title;
    document.getElementById("vid-meta").textContent =
      `\u2014 ${video.channel || "?"} \u00b7 ${video.views?.toLocaleString()||"?"} views \u00b7 ${video.published||""}`;
    document.getElementById("counter").textContent = `${viewCount} viewed`;
    renderRating(meta.rating || -1);
    document.getElementById("btn-fav").classList.toggle("active", !!meta.favorited);
    playVideo(video.id);
    fillQueue();
  }

  function next() { if(!queue.length) fillQueue(); if(!queue.length) return; if(current) history.push(current); showVideo(queue.shift()); }
  function prev() { if(!history.length) return; if(current) queue.unshift(current); showVideo(history.pop()); }

  function renderRating(r) {
    const c = document.getElementById("rating"); c.innerHTML = "";
    for (let i=1;i<=5;i++) { const s=document.createElement("span"); s.className=`star ${i<=r?"filled":""}`; s.textContent="\u2605"; s.onclick=()=>rateVideo(i); c.appendChild(s); }
  }
  function rateVideo(r) { if(!current) return; const s=getStore(); s[current.id]={...(s[current.id]||{}),rating:r}; saveStore(s); renderRating(r); if(r===0) next(); }
  function toggleFavorite() { if(!current) return; const s=getStore(),m=s[current.id]||{}; m.favorited=!m.favorited; s[current.id]=m; saveStore(s); document.getElementById("btn-fav").classList.toggle("active",m.favorited); }

  document.addEventListener("keydown", e => {
    if(e.key==="ArrowRight"||e.key===" "||e.key==="j"){e.preventDefault();next();}
    else if(e.key==="ArrowLeft"||e.key==="k"){e.preventDefault();prev();}
    else if(e.key==="f") toggleFavorite();
    else if(e.key>="1"&&e.key<="5") rateVideo(parseInt(e.key));
    else if(e.key==="0") rateVideo(0);
  });

  // Wait for both data and YT API
  (async () => {
    await loadData();
    // Wait for YT API if not ready yet
    while (!ytReady) await new Promise(r => setTimeout(r, 50));
    document.getElementById("loading").classList.add("hidden");
    applyFilters();
  })();
</script>
</body>
</html>
