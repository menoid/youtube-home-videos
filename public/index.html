<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Feed</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      height: 100%;
      overflow: hidden;
      user-select: none;
    }

    #feed {
      height: 100%;
      width: 100%;
      position: relative;
    }

    .slide {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .slide.current { transform: translateY(0); opacity: 1; z-index: 2; }
    .slide.next { transform: translateY(100%); opacity: 0; z-index: 1; }
    .slide.prev { transform: translateY(-100%); opacity: 0; z-index: 1; }
    .slide.hidden { display: none; }

    .slide iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Info overlay */
    #info-overlay {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 20px 20px 30px;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      z-index: 10;
      pointer-events: none;
    }

    #info-overlay .title {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 4px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    }

    #info-overlay .meta {
      font-size: 12px;
      color: #aaa;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    }

    /* Side actions */
    #actions {
      position: fixed;
      right: 16px;
      bottom: 120px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      z-index: 10;
    }

    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .action-btn .icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.15s;
    }

    .action-btn .icon:hover { background: rgba(255,255,255,0.2); }
    .action-btn.active .icon { background: rgba(255,50,50,0.6); }

    .action-btn .label {
      font-size: 10px;
      color: #aaa;
    }

    /* Rating stars */
    #rating {
      position: fixed;
      right: 16px;
      bottom: 80px;
      z-index: 10;
      display: flex;
      gap: 4px;
    }

    .star {
      font-size: 22px;
      cursor: pointer;
      opacity: 0.3;
      transition: opacity 0.15s;
    }

    .star.filled { opacity: 1; }
    .star:hover { opacity: 0.7; }

    /* Counter */
    #counter {
      position: fixed;
      top: 16px;
      left: 16px;
      font-size: 12px;
      color: #555;
      z-index: 10;
    }

    #stats {
      position: fixed;
      top: 16px;
      right: 16px;
      font-size: 11px;
      color: #444;
      z-index: 10;
      text-align: right;
    }

    /* Loading */
    #loading {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      z-index: 100;
      font-size: 14px;
      color: #555;
    }

    #loading.hidden { display: none; }

    #hints {
      position: fixed;
      bottom: 16px;
      left: 16px;
      font-size: 10px;
      color: #333;
      z-index: 10;
      line-height: 1.6;
    }
  </style>
</head>
<body>

<div id="loading">Loading feed...</div>

<div id="feed">
  <div class="slide hidden" id="slide-0"></div>
  <div class="slide hidden" id="slide-1"></div>
  <div class="slide hidden" id="slide-2"></div>
</div>

<div id="info-overlay">
  <div class="title" id="vid-title"></div>
  <div class="meta" id="vid-meta"></div>
</div>

<div id="actions">
  <div class="action-btn" id="btn-fav" onclick="toggleFavorite()">
    <div class="icon">&#9829;</div>
    <div class="label">save</div>
  </div>
  <div class="action-btn" id="btn-skip" onclick="next()">
    <div class="icon">&#8595;</div>
    <div class="label">next</div>
  </div>
</div>

<div id="rating"></div>

<div id="counter"></div>
<div id="stats"></div>

<div id="hints">
  &#8595; / Space = next &nbsp; &#8593; = prev &nbsp; 1-5 = rate &nbsp; F = fav
</div>

<script>
  const BUFFER_SIZE = 10;

  let allVideos = [];
  let queue = [];
  let history = [];
  let current = null;
  let seenIds = new Set();
  let viewCount = 0;

  // localStorage for ratings/favorites
  function getStore() {
    try { return JSON.parse(localStorage.getItem("yt-feed-store") || "{}"); }
    catch { return {}; }
  }
  function saveStore(store) {
    localStorage.setItem("yt-feed-store", JSON.stringify(store));
  }

  const slides = [
    document.getElementById("slide-0"),
    document.getElementById("slide-1"),
    document.getElementById("slide-2"),
  ];
  let activeSlideIdx = 0;

  // Shuffle
  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  async function loadData() {
    const res = await fetch("data.json");
    allVideos = await res.json();

    // Filter out rejected (rating 0) from localStorage
    const store = getStore();
    allVideos = allVideos.filter(v => (store[v.id]?.rating ?? -1) !== 0);

    queue = shuffle(allVideos);
  }

  function fillQueue() {
    if (queue.length < BUFFER_SIZE) {
      const fresh = shuffle(allVideos.filter(v => !seenIds.has(v.id)));
      queue.push(...fresh);
    }
  }

  function createEmbed(videoId) {
    return `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1&modestbranding=1&rel=0&playsinline=1"
            allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
  }

  function showVideo(video, direction) {
    if (!video) return;

    current = video;
    seenIds.add(video.id);
    viewCount++;

    const store = getStore();
    const meta = store[video.id] || {};

    document.getElementById("vid-title").textContent = video.title;
    document.getElementById("vid-meta").textContent =
      `${video.channel || ""} · ${video.views?.toLocaleString() || "?"} views · ${video.published || ""}`;
    document.getElementById("counter").textContent = `${viewCount} viewed`;

    renderRating(meta.rating || -1);
    document.getElementById("btn-fav").classList.toggle("active", !!meta.favorited);

    const prevSlideIdx = activeSlideIdx;
    activeSlideIdx = (activeSlideIdx + 1) % 3;

    slides[activeSlideIdx].innerHTML = createEmbed(video.id);

    slides.forEach((s, i) => {
      s.classList.remove("current", "next", "prev", "hidden");
      if (i === activeSlideIdx) {
        s.classList.add("current");
      } else if (i === prevSlideIdx) {
        s.classList.add(direction === "next" ? "prev" : "next");
        setTimeout(() => { s.innerHTML = ""; }, 400);
      } else {
        s.classList.add("hidden");
      }
    });

    fillQueue();
    updateStats();
  }

  function next() {
    if (queue.length === 0) fillQueue();
    if (queue.length === 0) return;
    if (current) history.push(current);
    showVideo(queue.shift(), "next");
  }

  function prev() {
    if (history.length === 0) return;
    if (current) queue.unshift(current);
    showVideo(history.pop(), "prev");
  }

  // Rating
  function renderRating(rating) {
    const container = document.getElementById("rating");
    container.innerHTML = "";
    for (let i = 1; i <= 5; i++) {
      const star = document.createElement("span");
      star.className = `star ${i <= rating ? "filled" : ""}`;
      star.textContent = "★";
      star.onclick = () => rateVideo(i);
      container.appendChild(star);
    }
  }

  function rateVideo(rating) {
    if (!current) return;
    const store = getStore();
    store[current.id] = { ...(store[current.id] || {}), rating };
    saveStore(store);
    renderRating(rating);
  }

  function toggleFavorite() {
    if (!current) return;
    const store = getStore();
    const meta = store[current.id] || {};
    meta.favorited = !meta.favorited;
    store[current.id] = meta;
    saveStore(store);
    document.getElementById("btn-fav").classList.toggle("active", meta.favorited);
  }

  function updateStats() {
    const store = getStore();
    const rated = Object.values(store).filter(m => m.rating > 0).length;
    const faved = Object.values(store).filter(m => m.favorited).length;
    document.getElementById("stats").innerHTML =
      `${allVideos.length} videos · ${viewCount} viewed · ${rated} rated · ${faved} saved`;
  }

  // Keyboard
  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowDown" || e.key === " " || e.key === "j") { e.preventDefault(); next(); }
    else if (e.key === "ArrowUp" || e.key === "k") { e.preventDefault(); prev(); }
    else if (e.key === "f") toggleFavorite();
    else if (e.key >= "1" && e.key <= "5") rateVideo(parseInt(e.key));
    else if (e.key === "0") rateVideo(0);
  });

  // Touch
  let touchStartY = 0;
  document.addEventListener("touchstart", (e) => { touchStartY = e.touches[0].clientY; });
  document.addEventListener("touchend", (e) => {
    const diff = touchStartY - e.changedTouches[0].clientY;
    if (diff > 50) next();
    else if (diff < -50) prev();
  });

  // Wheel
  let wheelCooldown = false;
  document.addEventListener("wheel", (e) => {
    if (wheelCooldown) return;
    wheelCooldown = true;
    setTimeout(() => { wheelCooldown = false; }, 500);
    if (e.deltaY > 0) next();
    else if (e.deltaY < 0) prev();
  });

  // Init
  async function init() {
    await loadData();
    document.getElementById("loading").classList.add("hidden");
    next();
  }

  init();
</script>

</body>
</html>
